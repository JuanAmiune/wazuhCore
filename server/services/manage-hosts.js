"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ManageHosts = void 0;
var _apiUserStatusRunAs = require("../../common/api-user-status-run-as");
var _constants = require("../../common/constants");
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); } /*
 * Wazuh app - Module to update the configuration file
 * Copyright (C) 2015-2022 Wazuh, Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * Find more information about this on the LICENSE file.
 */
/**
 * This service manages the API connections.
 * Get API hosts configuration
 * Get API host entries (combine configuration and registry data)
 * Create API host
 * Update API host
 * Delete API host
 * Cache the registry data for API hosts
 * Ability to get if the configured user is allowed to use run as
 */
class ManageHosts {
  constructor(logger, configuration) {
    this.logger = logger;
    this.configuration = configuration;
    _defineProperty(this, "serverAPIClient", null);
    _defineProperty(this, "cacheRegistry", new Map());
  }
  setServerAPIClient(client) {
    this.serverAPIClient = client;
  }
  /**
   * Exclude fields from an API host data
   * @param host
   * @param exclude
   * @returns
   */
  filterAPIHostData(host, exclude) {
    return exclude !== null && exclude !== void 0 && exclude.length ? Object.entries(host).reduce((accum, [key, value]) => ({
      ...accum,
      ...(!exclude.includes(key) ? {
        [key]: value
      } : {})
    }), {}) : host;
  }

  /**
   * Get hosts or host by ID from configuration
   */
  async get(hostID, options = {
    excludePassword: false
  }) {
    try {
      hostID ? this.logger.debug(`Getting API connection with ID [${hostID}]`) : this.logger.debug('Getting API connections');
      const hosts = await this.configuration.get('hosts');
      this.logger.debug(`API connections: [${JSON.stringify(hosts)}]`);
      if (hostID) {
        const host = hosts.find(({
          id
        }) => id === hostID);
        if (host) {
          this.logger.debug(`API connection with ID [${hostID}] found`);
          return this.filterAPIHostData(host, options.excludePassword ? ['password'] : undefined);
        }
        const APIConnectionNotFound = `API connection with ID [${hostID}] not found`;
        this.logger.debug(APIConnectionNotFound);
        throw new Error(APIConnectionNotFound);
      }
      return hosts.map(host => this.filterAPIHostData(host, options.excludePassword ? ['password'] : undefined));
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }

  /**
   * This get all hosts entries in the plugins configuration and the related info in the wazuh-registry.json
   * @param {Object} context
   * @param {Object} request
   * @param {Object} response
   * API entries
   */
  async getEntries(options = {
    excludePassword: false
  }) {
    try {
      this.logger.debug('Getting the API connections');
      const hosts = await this.get(undefined, options);
      this.logger.debug('Getting registry');
      const registry = Object.fromEntries([...this.cacheRegistry.entries()]);
      return hosts.map(host => {
        const {
          id
        } = host;
        return {
          ...host,
          cluster_info: registry[id]
        };
      });
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }
  isServerAPIClientResponseOk(response) {
    return response.status === _constants.HTTP_STATUS_CODES.OK;
  }

  /**
   * Get the cluster info and allow_run_as values for the API host and store into the registry cache
   * @param host
   * @returns
   */
  async getRegistryDataByHost(host, options) {
    const apiHostID = host.id;
    this.logger.debug(`Getting registry data from host [${apiHostID}]`);
    // Get cluster info data

    let manager = null,
      node = null,
      status = 'disabled',
      cluster = 'Disabled',
      allow_run_as = _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.UNABLE_TO_CHECK;
    try {
      var _responseClusterStatu;
      const responseAgents = await this.serverAPIClient.asInternalUser.request('GET', `/agents`, {
        params: {
          agents_list: '000'
        }
      }, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseAgents)) {
        manager = responseAgents.data.data.affected_items[0].manager;
      }

      // Get allow_run_as
      const responseAllowRunAs = await this.serverAPIClient.asInternalUser.request('GET', '/security/users/me', {}, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseAllowRunAs)) {
        const allow_run_as_response = responseAllowRunAs.data.data.affected_items[0].allow_run_as;
        if (host.run_as) {
          allow_run_as = allow_run_as_response ? _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED : _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.USER_NOT_ALLOWED;
        } else {
          allow_run_as = allow_run_as_response ? _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.HOST_DISABLED : _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ALL_DISABLED;
        }
      }
      const responseClusterStatus = await this.serverAPIClient.asInternalUser.request('GET', `/cluster/status`, {}, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseClusterStatus) && ((_responseClusterStatu = responseClusterStatus.data) === null || _responseClusterStatu === void 0 || (_responseClusterStatu = _responseClusterStatu.data) === null || _responseClusterStatu === void 0 ? void 0 : _responseClusterStatu.enabled) === 'yes') {
        status = 'enabled';
        const responseClusterLocal = await this.serverAPIClient.asInternalUser.request('GET', `/cluster/local/info`, {}, {
          apiHostID
        });
        if (this.isServerAPIClientResponseOk(responseClusterLocal)) {
          node = responseClusterLocal.data.data.affected_items[0].node;
          cluster = responseClusterLocal.data.data.affected_items[0].cluster;
        }
      }
    } catch (error) {
      if (options !== null && options !== void 0 && options.throwError) {
        throw error;
      }
    }
    const data = {
      manager,
      node,
      status,
      cluster,
      allow_run_as
    };
    this.updateRegistryByHost(apiHostID, data);
    return data;
  }

  /**
   * Initialize the service on plugin start.
   * - Get the registry data for the configured API hosts and store into the in memory cache
   * @returns
   */
  async start() {
    try {
      this.logger.debug('Start');
      const hosts = await this.get(undefined, {
        excludePassword: true
      });
      if (!hosts.length) {
        this.logger.debug('No hosts found. Skip.');
        return;
      }
      await Promise.all(hosts.map(host => (async () => [host.id, await this.getRegistryDataByHost(host)])()));
      this.logger.debug('API hosts data stored in the registry');
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }
  getRegistryByHost(hostID) {
    this.logger.debug(`Getting cache for API host [${hostID}]`);
    const result = this.cacheRegistry.get(hostID);
    this.logger.debug(`Get cache for APIhost [${hostID}]`);
    return result;
  }
  updateRegistryByHost(hostID, data) {
    this.logger.debug(`Updating cache for APIhost [${hostID}]`);
    const result = this.cacheRegistry.set(hostID, data);
    this.logger.debug(`Updated cache for APIhost [${hostID}]`);
    return result;
  }
  deleteRegistryByHost(hostID) {
    this.logger.debug(`Deleting cache for API host [${hostID}]`);
    const result = this.cacheRegistry.delete(hostID);
    this.logger.debug(`Deleted cache for API host [${hostID}]`);
    return result;
  }

  /**
   * Check if the authentication with run_as is enabled and the API user can use it
   * @param apiId
   * @returns
   */
  isEnabledAuthWithRunAs(apiId) {
    this.logger.debug(`Checking if the API host [${apiId}] can use the run_as`);
    const registryHost = this.getRegistryByHost(apiId);
    if (!registryHost) {
      throw new Error(`API host with ID [${apiId}] was not found in the registry. This could be caused by a problem getting and storing the registry data or the API host was removed.`);
    }
    if (registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.UNABLE_TO_CHECK) {
      throw new Error(`API host with host ID [${apiId}] could not check the ability to use the run as. Ensure the API host is accesible and the internal user has the minimal permissions to check this capability.`);
    }
    if (registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.USER_NOT_ALLOWED) {
      throw new Error(`API host with host ID [${apiId}] misconfigured. The configurated API user is not allowed to use [run_as]. Allow it in the API user configuration or set [run_as] host setting with [false] value.`);
    }

    /* The allowed values to compare should be:
      API_USER_STATUS_RUN_AS.ENABLED: use run_as
      API_USER_STATUS_RUN_AS.HOST_DISABLED: not use run_as
      API_USER_STATUS_RUN_AS.ALL_DISABLED: not use run_as
    */
    if (![_apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED, _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.HOST_DISABLED, _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ALL_DISABLED].includes(registryHost.allow_run_as)) {
      throw new Error(`API host with host ID [${apiId}] has an unexpected value [${registryHost.allow_run_as}] stored in the registry. This could be caused by a problem getting and storing the registry data.`);
    }
    return registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED;
  }
}
exports.ManageHosts = ManageHosts;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXBpVXNlclN0YXR1c1J1bkFzIiwicmVxdWlyZSIsIl9jb25zdGFudHMiLCJfZGVmaW5lUHJvcGVydHkiLCJvYmoiLCJrZXkiLCJ2YWx1ZSIsIl90b1Byb3BlcnR5S2V5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwiU3ltYm9sIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJyZXMiLCJjYWxsIiwiVHlwZUVycm9yIiwiTnVtYmVyIiwiTWFuYWdlSG9zdHMiLCJjb25zdHJ1Y3RvciIsImxvZ2dlciIsImNvbmZpZ3VyYXRpb24iLCJNYXAiLCJzZXRTZXJ2ZXJBUElDbGllbnQiLCJjbGllbnQiLCJzZXJ2ZXJBUElDbGllbnQiLCJmaWx0ZXJBUElIb3N0RGF0YSIsImhvc3QiLCJleGNsdWRlIiwibGVuZ3RoIiwiZW50cmllcyIsInJlZHVjZSIsImFjY3VtIiwiaW5jbHVkZXMiLCJnZXQiLCJob3N0SUQiLCJvcHRpb25zIiwiZXhjbHVkZVBhc3N3b3JkIiwiZGVidWciLCJob3N0cyIsIkpTT04iLCJzdHJpbmdpZnkiLCJmaW5kIiwiaWQiLCJBUElDb25uZWN0aW9uTm90Rm91bmQiLCJFcnJvciIsIm1hcCIsImVycm9yIiwibWVzc2FnZSIsImdldEVudHJpZXMiLCJyZWdpc3RyeSIsImZyb21FbnRyaWVzIiwiY2FjaGVSZWdpc3RyeSIsImNsdXN0ZXJfaW5mbyIsImlzU2VydmVyQVBJQ2xpZW50UmVzcG9uc2VPayIsInJlc3BvbnNlIiwic3RhdHVzIiwiSFRUUF9TVEFUVVNfQ09ERVMiLCJPSyIsImdldFJlZ2lzdHJ5RGF0YUJ5SG9zdCIsImFwaUhvc3RJRCIsIm1hbmFnZXIiLCJub2RlIiwiY2x1c3RlciIsImFsbG93X3J1bl9hcyIsIkFQSV9VU0VSX1NUQVRVU19SVU5fQVMiLCJVTkFCTEVfVE9fQ0hFQ0siLCJfcmVzcG9uc2VDbHVzdGVyU3RhdHUiLCJyZXNwb25zZUFnZW50cyIsImFzSW50ZXJuYWxVc2VyIiwicmVxdWVzdCIsInBhcmFtcyIsImFnZW50c19saXN0IiwiZGF0YSIsImFmZmVjdGVkX2l0ZW1zIiwicmVzcG9uc2VBbGxvd1J1bkFzIiwiYWxsb3dfcnVuX2FzX3Jlc3BvbnNlIiwicnVuX2FzIiwiRU5BQkxFRCIsIlVTRVJfTk9UX0FMTE9XRUQiLCJIT1NUX0RJU0FCTEVEIiwiQUxMX0RJU0FCTEVEIiwicmVzcG9uc2VDbHVzdGVyU3RhdHVzIiwiZW5hYmxlZCIsInJlc3BvbnNlQ2x1c3RlckxvY2FsIiwidGhyb3dFcnJvciIsInVwZGF0ZVJlZ2lzdHJ5QnlIb3N0Iiwic3RhcnQiLCJQcm9taXNlIiwiYWxsIiwiZ2V0UmVnaXN0cnlCeUhvc3QiLCJyZXN1bHQiLCJzZXQiLCJkZWxldGVSZWdpc3RyeUJ5SG9zdCIsImRlbGV0ZSIsImlzRW5hYmxlZEF1dGhXaXRoUnVuQXMiLCJhcGlJZCIsInJlZ2lzdHJ5SG9zdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyJtYW5hZ2UtaG9zdHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFdhenVoIGFwcCAtIE1vZHVsZSB0byB1cGRhdGUgdGhlIGNvbmZpZ3VyYXRpb24gZmlsZVxuICogQ29weXJpZ2h0IChDKSAyMDE1LTIwMjIgV2F6dWgsIEluYy5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDIgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEZpbmQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCB0aGlzIG9uIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ29wZW5zZWFyY2gtZGFzaGJvYXJkcy9zZXJ2ZXInO1xuaW1wb3J0IHsgSUNvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9jb21tb24vc2VydmljZXMvY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBTZXJ2ZXJBUElDbGllbnQgfSBmcm9tICcuL3NlcnZlci1hcGktY2xpZW50JztcbmltcG9ydCB7IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMgfSBmcm9tICcuLi8uLi9jb21tb24vYXBpLXVzZXItc3RhdHVzLXJ1bi1hcyc7XG5pbXBvcnQgeyBIVFRQX1NUQVRVU19DT0RFUyB9IGZyb20gJy4uLy4uL2NvbW1vbi9jb25zdGFudHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElBUElIb3N0IHtcbiAgaWQ6IHN0cmluZztcbiAgdXJsOiBzdHJpbmc7XG4gIHVzZXJuYW1lOiBzdHJpbmc7XG4gIHBhc3N3b3JkOiBzdHJpbmc7XG4gIHBvcnQ6IG51bWJlcjtcbiAgcnVuX2FzOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSUFQSUhvc3RSZWdpc3RyeSB7XG4gIG1hbmFnZXI6IHN0cmluZyB8IG51bGw7XG4gIG5vZGU6IHN0cmluZyB8IG51bGw7XG4gIHN0YXR1czogc3RyaW5nO1xuICBjbHVzdGVyOiBzdHJpbmc7XG4gIGFsbG93X3J1bl9hczogQVBJX1VTRVJfU1RBVFVTX1JVTl9BUztcbn1cblxuaW50ZXJmYWNlIEdldFJlZ2lzdHJ5RGF0YUJ5SG9zdE9wdGlvbnMge1xuICAvKiB0aGlzIG9wdGlvbiBsZXRzIHRvIHRocm93IHRoZSBlcnJvciB3aGVuIHRyeWluZyB0byBmZXRjaCB0aGUgcmVxdWlyZWQgZGF0YVxuICBvZiB0aGUgQVBJIGhvc3QgdGhhdCBpcyB1c2VkIGJ5IHRoZSBjaGVja1N0b3JlZEFQSSBvZiAvYXBpL2NoZWNrLXN0b3JlZC1hcGlcbiAgZW5kcG9pbnQgKi9cbiAgdGhyb3dFcnJvcjogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBUaGlzIHNlcnZpY2UgbWFuYWdlcyB0aGUgQVBJIGNvbm5lY3Rpb25zLlxuICogR2V0IEFQSSBob3N0cyBjb25maWd1cmF0aW9uXG4gKiBHZXQgQVBJIGhvc3QgZW50cmllcyAoY29tYmluZSBjb25maWd1cmF0aW9uIGFuZCByZWdpc3RyeSBkYXRhKVxuICogQ3JlYXRlIEFQSSBob3N0XG4gKiBVcGRhdGUgQVBJIGhvc3RcbiAqIERlbGV0ZSBBUEkgaG9zdFxuICogQ2FjaGUgdGhlIHJlZ2lzdHJ5IGRhdGEgZm9yIEFQSSBob3N0c1xuICogQWJpbGl0eSB0byBnZXQgaWYgdGhlIGNvbmZpZ3VyZWQgdXNlciBpcyBhbGxvd2VkIHRvIHVzZSBydW4gYXNcbiAqL1xuZXhwb3J0IGNsYXNzIE1hbmFnZUhvc3RzIHtcbiAgcHVibGljIHNlcnZlckFQSUNsaWVudDogU2VydmVyQVBJQ2xpZW50IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgY2FjaGVSZWdpc3RyeTogTWFwPHN0cmluZywgSUFQSUhvc3RSZWdpc3RyeT4gPSBuZXcgTWFwKCk7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9nZ2VyOiBMb2dnZXIsIHByaXZhdGUgY29uZmlndXJhdGlvbjogSUNvbmZpZ3VyYXRpb24pIHt9XG5cbiAgc2V0U2VydmVyQVBJQ2xpZW50KGNsaWVudDogU2VydmVyQVBJQ2xpZW50KSB7XG4gICAgdGhpcy5zZXJ2ZXJBUElDbGllbnQgPSBjbGllbnQ7XG4gIH1cbiAgLyoqXG4gICAqIEV4Y2x1ZGUgZmllbGRzIGZyb20gYW4gQVBJIGhvc3QgZGF0YVxuICAgKiBAcGFyYW0gaG9zdFxuICAgKiBAcGFyYW0gZXhjbHVkZVxuICAgKiBAcmV0dXJuc1xuICAgKi9cbiAgcHJpdmF0ZSBmaWx0ZXJBUElIb3N0RGF0YShob3N0OiBJQVBJSG9zdCwgZXhjbHVkZTogc3RyaW5nW10pIHtcbiAgICByZXR1cm4gZXhjbHVkZT8ubGVuZ3RoXG4gICAgICA/IE9iamVjdC5lbnRyaWVzKGhvc3QpLnJlZHVjZShcbiAgICAgICAgICAoYWNjdW0sIFtrZXksIHZhbHVlXSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmFjY3VtLFxuICAgICAgICAgICAgLi4uKCFleGNsdWRlLmluY2x1ZGVzKGtleSkgPyB7IFtrZXldOiB2YWx1ZSB9IDoge30pLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHt9LFxuICAgICAgICApXG4gICAgICA6IGhvc3Q7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGhvc3RzIG9yIGhvc3QgYnkgSUQgZnJvbSBjb25maWd1cmF0aW9uXG4gICAqL1xuICBhc3luYyBnZXQoXG4gICAgaG9zdElEPzogc3RyaW5nLFxuICAgIG9wdGlvbnM6IHsgZXhjbHVkZVBhc3N3b3JkOiBib29sZWFuIH0gPSB7IGV4Y2x1ZGVQYXNzd29yZDogZmFsc2UgfSxcbiAgKTogUHJvbWlzZTxJQVBJSG9zdFtdIHwgSUFQSUhvc3Q+IHtcbiAgICB0cnkge1xuICAgICAgaG9zdElEXG4gICAgICAgID8gdGhpcy5sb2dnZXIuZGVidWcoYEdldHRpbmcgQVBJIGNvbm5lY3Rpb24gd2l0aCBJRCBbJHtob3N0SUR9XWApXG4gICAgICAgIDogdGhpcy5sb2dnZXIuZGVidWcoJ0dldHRpbmcgQVBJIGNvbm5lY3Rpb25zJyk7XG4gICAgICBjb25zdCBob3N0cyA9IGF3YWl0IHRoaXMuY29uZmlndXJhdGlvbi5nZXQoJ2hvc3RzJyk7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQVBJIGNvbm5lY3Rpb25zOiBbJHtKU09OLnN0cmluZ2lmeShob3N0cyl9XWApO1xuICAgICAgaWYgKGhvc3RJRCkge1xuICAgICAgICBjb25zdCBob3N0ID0gaG9zdHMuZmluZCgoeyBpZCB9OiB7IGlkOiBzdHJpbmcgfSkgPT4gaWQgPT09IGhvc3RJRCk7XG4gICAgICAgIGlmIChob3N0KSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEFQSSBjb25uZWN0aW9uIHdpdGggSUQgWyR7aG9zdElEfV0gZm91bmRgKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXJBUElIb3N0RGF0YShcbiAgICAgICAgICAgIGhvc3QsXG4gICAgICAgICAgICBvcHRpb25zLmV4Y2x1ZGVQYXNzd29yZCA/IFsncGFzc3dvcmQnXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IEFQSUNvbm5lY3Rpb25Ob3RGb3VuZCA9IGBBUEkgY29ubmVjdGlvbiB3aXRoIElEIFske2hvc3RJRH1dIG5vdCBmb3VuZGA7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKEFQSUNvbm5lY3Rpb25Ob3RGb3VuZCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihBUElDb25uZWN0aW9uTm90Rm91bmQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGhvc3RzLm1hcChob3N0ID0+XG4gICAgICAgIHRoaXMuZmlsdGVyQVBJSG9zdERhdGEoXG4gICAgICAgICAgaG9zdCxcbiAgICAgICAgICBvcHRpb25zLmV4Y2x1ZGVQYXNzd29yZCA/IFsncGFzc3dvcmQnXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZ2V0IGFsbCBob3N0cyBlbnRyaWVzIGluIHRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24gYW5kIHRoZSByZWxhdGVkIGluZm8gaW4gdGhlIHdhenVoLXJlZ2lzdHJ5Lmpzb25cbiAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRcbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3RcbiAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlXG4gICAqIEFQSSBlbnRyaWVzXG4gICAqL1xuICBhc3luYyBnZXRFbnRyaWVzKFxuICAgIG9wdGlvbnM6IHsgZXhjbHVkZVBhc3N3b3JkOiBib29sZWFuIH0gPSB7IGV4Y2x1ZGVQYXNzd29yZDogZmFsc2UgfSxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdHZXR0aW5nIHRoZSBBUEkgY29ubmVjdGlvbnMnKTtcbiAgICAgIGNvbnN0IGhvc3RzID0gKGF3YWl0IHRoaXMuZ2V0KHVuZGVmaW5lZCwgb3B0aW9ucykpIGFzIElBUElIb3N0W107XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnR2V0dGluZyByZWdpc3RyeScpO1xuICAgICAgY29uc3QgcmVnaXN0cnkgPSBPYmplY3QuZnJvbUVudHJpZXMoWy4uLnRoaXMuY2FjaGVSZWdpc3RyeS5lbnRyaWVzKCldKTtcbiAgICAgIHJldHVybiBob3N0cy5tYXAoaG9zdCA9PiB7XG4gICAgICAgIGNvbnN0IHsgaWQgfSA9IGhvc3Q7XG4gICAgICAgIHJldHVybiB7IC4uLmhvc3QsIGNsdXN0ZXJfaW5mbzogcmVnaXN0cnlbaWRdIH07XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzU2VydmVyQVBJQ2xpZW50UmVzcG9uc2VPayhyZXNwb25zZTogeyBzdGF0dXM6IG51bWJlciB9KSB7XG4gICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyA9PT0gSFRUUF9TVEFUVVNfQ09ERVMuT0s7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBjbHVzdGVyIGluZm8gYW5kIGFsbG93X3J1bl9hcyB2YWx1ZXMgZm9yIHRoZSBBUEkgaG9zdCBhbmQgc3RvcmUgaW50byB0aGUgcmVnaXN0cnkgY2FjaGVcbiAgICogQHBhcmFtIGhvc3RcbiAgICogQHJldHVybnNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0UmVnaXN0cnlEYXRhQnlIb3N0KFxuICAgIGhvc3Q6IElBUElIb3N0LFxuICAgIG9wdGlvbnM6IEdldFJlZ2lzdHJ5RGF0YUJ5SG9zdE9wdGlvbnMsXG4gICk6IFByb21pc2U8SUFQSUhvc3RSZWdpc3RyeT4ge1xuICAgIGNvbnN0IGFwaUhvc3RJRCA9IGhvc3QuaWQ7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYEdldHRpbmcgcmVnaXN0cnkgZGF0YSBmcm9tIGhvc3QgWyR7YXBpSG9zdElEfV1gKTtcbiAgICAvLyBHZXQgY2x1c3RlciBpbmZvIGRhdGFcblxuICAgIGxldCBtYW5hZ2VyID0gbnVsbCxcbiAgICAgIG5vZGUgPSBudWxsLFxuICAgICAgc3RhdHVzID0gJ2Rpc2FibGVkJyxcbiAgICAgIGNsdXN0ZXIgPSAnRGlzYWJsZWQnLFxuICAgICAgYWxsb3dfcnVuX2FzID0gQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5VTkFCTEVfVE9fQ0hFQ0s7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2VBZ2VudHMgPSBhd2FpdCB0aGlzLnNlcnZlckFQSUNsaWVudC5hc0ludGVybmFsVXNlci5yZXF1ZXN0KFxuICAgICAgICAnR0VUJyxcbiAgICAgICAgYC9hZ2VudHNgLFxuICAgICAgICB7IHBhcmFtczogeyBhZ2VudHNfbGlzdDogJzAwMCcgfSB9LFxuICAgICAgICB7IGFwaUhvc3RJRCB9LFxuICAgICAgKTtcblxuICAgICAgaWYgKHRoaXMuaXNTZXJ2ZXJBUElDbGllbnRSZXNwb25zZU9rKHJlc3BvbnNlQWdlbnRzKSkge1xuICAgICAgICBtYW5hZ2VyID0gcmVzcG9uc2VBZ2VudHMuZGF0YS5kYXRhLmFmZmVjdGVkX2l0ZW1zWzBdLm1hbmFnZXI7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBhbGxvd19ydW5fYXNcbiAgICAgIGNvbnN0IHJlc3BvbnNlQWxsb3dSdW5BcyA9XG4gICAgICAgIGF3YWl0IHRoaXMuc2VydmVyQVBJQ2xpZW50LmFzSW50ZXJuYWxVc2VyLnJlcXVlc3QoXG4gICAgICAgICAgJ0dFVCcsXG4gICAgICAgICAgJy9zZWN1cml0eS91c2Vycy9tZScsXG4gICAgICAgICAge30sXG4gICAgICAgICAgeyBhcGlIb3N0SUQgfSxcbiAgICAgICAgKTtcbiAgICAgIGlmICh0aGlzLmlzU2VydmVyQVBJQ2xpZW50UmVzcG9uc2VPayhyZXNwb25zZUFsbG93UnVuQXMpKSB7XG4gICAgICAgIGNvbnN0IGFsbG93X3J1bl9hc19yZXNwb25zZSA9XG4gICAgICAgICAgcmVzcG9uc2VBbGxvd1J1bkFzLmRhdGEuZGF0YS5hZmZlY3RlZF9pdGVtc1swXS5hbGxvd19ydW5fYXM7XG4gICAgICAgIGlmIChob3N0LnJ1bl9hcykge1xuICAgICAgICAgIGFsbG93X3J1bl9hcyA9IGFsbG93X3J1bl9hc19yZXNwb25zZVxuICAgICAgICAgICAgPyBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkVOQUJMRURcbiAgICAgICAgICAgIDogQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5VU0VSX05PVF9BTExPV0VEO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFsbG93X3J1bl9hcyA9IGFsbG93X3J1bl9hc19yZXNwb25zZVxuICAgICAgICAgICAgPyBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkhPU1RfRElTQUJMRURcbiAgICAgICAgICAgIDogQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5BTExfRElTQUJMRUQ7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzcG9uc2VDbHVzdGVyU3RhdHVzID1cbiAgICAgICAgYXdhaXQgdGhpcy5zZXJ2ZXJBUElDbGllbnQuYXNJbnRlcm5hbFVzZXIucmVxdWVzdChcbiAgICAgICAgICAnR0VUJyxcbiAgICAgICAgICBgL2NsdXN0ZXIvc3RhdHVzYCxcbiAgICAgICAgICB7fSxcbiAgICAgICAgICB7IGFwaUhvc3RJRCB9LFxuICAgICAgICApO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMuaXNTZXJ2ZXJBUElDbGllbnRSZXNwb25zZU9rKHJlc3BvbnNlQ2x1c3RlclN0YXR1cykgJiZcbiAgICAgICAgcmVzcG9uc2VDbHVzdGVyU3RhdHVzLmRhdGE/LmRhdGE/LmVuYWJsZWQgPT09ICd5ZXMnXG4gICAgICApIHtcbiAgICAgICAgc3RhdHVzID0gJ2VuYWJsZWQnO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlQ2x1c3RlckxvY2FsID1cbiAgICAgICAgICBhd2FpdCB0aGlzLnNlcnZlckFQSUNsaWVudC5hc0ludGVybmFsVXNlci5yZXF1ZXN0KFxuICAgICAgICAgICAgJ0dFVCcsXG4gICAgICAgICAgICBgL2NsdXN0ZXIvbG9jYWwvaW5mb2AsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIHsgYXBpSG9zdElEIH0sXG4gICAgICAgICAgKTtcblxuICAgICAgICBpZiAodGhpcy5pc1NlcnZlckFQSUNsaWVudFJlc3BvbnNlT2socmVzcG9uc2VDbHVzdGVyTG9jYWwpKSB7XG4gICAgICAgICAgbm9kZSA9IHJlc3BvbnNlQ2x1c3RlckxvY2FsLmRhdGEuZGF0YS5hZmZlY3RlZF9pdGVtc1swXS5ub2RlO1xuICAgICAgICAgIGNsdXN0ZXIgPSByZXNwb25zZUNsdXN0ZXJMb2NhbC5kYXRhLmRhdGEuYWZmZWN0ZWRfaXRlbXNbMF0uY2x1c3RlcjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAob3B0aW9ucz8udGhyb3dFcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgbWFuYWdlcixcbiAgICAgIG5vZGUsXG4gICAgICBzdGF0dXMsXG4gICAgICBjbHVzdGVyLFxuICAgICAgYWxsb3dfcnVuX2FzLFxuICAgIH07XG4gICAgdGhpcy51cGRhdGVSZWdpc3RyeUJ5SG9zdChhcGlIb3N0SUQsIGRhdGEpO1xuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdGhlIHNlcnZpY2Ugb24gcGx1Z2luIHN0YXJ0LlxuICAgKiAtIEdldCB0aGUgcmVnaXN0cnkgZGF0YSBmb3IgdGhlIGNvbmZpZ3VyZWQgQVBJIGhvc3RzIGFuZCBzdG9yZSBpbnRvIHRoZSBpbiBtZW1vcnkgY2FjaGVcbiAgICogQHJldHVybnNcbiAgICovXG4gIGFzeW5jIHN0YXJ0KCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnU3RhcnQnKTtcbiAgICAgIGNvbnN0IGhvc3RzID0gKGF3YWl0IHRoaXMuZ2V0KHVuZGVmaW5lZCwge1xuICAgICAgICBleGNsdWRlUGFzc3dvcmQ6IHRydWUsXG4gICAgICB9KSkgYXMgSUFQSUhvc3RbXTtcbiAgICAgIGlmICghaG9zdHMubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdObyBob3N0cyBmb3VuZC4gU2tpcC4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgaG9zdHMubWFwKGhvc3QgPT5cbiAgICAgICAgICAoYXN5bmMgKCkgPT4gW2hvc3QuaWQsIGF3YWl0IHRoaXMuZ2V0UmVnaXN0cnlEYXRhQnlIb3N0KGhvc3QpXSkoKSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnQVBJIGhvc3RzIGRhdGEgc3RvcmVkIGluIHRoZSByZWdpc3RyeScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVnaXN0cnlCeUhvc3QoaG9zdElEOiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgR2V0dGluZyBjYWNoZSBmb3IgQVBJIGhvc3QgWyR7aG9zdElEfV1gKTtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNhY2hlUmVnaXN0cnkuZ2V0KGhvc3RJRCk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYEdldCBjYWNoZSBmb3IgQVBJaG9zdCBbJHtob3N0SUR9XWApO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVJlZ2lzdHJ5QnlIb3N0KGhvc3RJRDogc3RyaW5nLCBkYXRhOiBhbnkpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXBkYXRpbmcgY2FjaGUgZm9yIEFQSWhvc3QgWyR7aG9zdElEfV1gKTtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNhY2hlUmVnaXN0cnkuc2V0KGhvc3RJRCwgZGF0YSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFVwZGF0ZWQgY2FjaGUgZm9yIEFQSWhvc3QgWyR7aG9zdElEfV1gKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBkZWxldGVSZWdpc3RyeUJ5SG9zdChob3N0SUQ6IHN0cmluZykge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBEZWxldGluZyBjYWNoZSBmb3IgQVBJIGhvc3QgWyR7aG9zdElEfV1gKTtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNhY2hlUmVnaXN0cnkuZGVsZXRlKGhvc3RJRCk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYERlbGV0ZWQgY2FjaGUgZm9yIEFQSSBob3N0IFske2hvc3RJRH1dYCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGUgYXV0aGVudGljYXRpb24gd2l0aCBydW5fYXMgaXMgZW5hYmxlZCBhbmQgdGhlIEFQSSB1c2VyIGNhbiB1c2UgaXRcbiAgICogQHBhcmFtIGFwaUlkXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBpc0VuYWJsZWRBdXRoV2l0aFJ1bkFzKGFwaUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQ2hlY2tpbmcgaWYgdGhlIEFQSSBob3N0IFske2FwaUlkfV0gY2FuIHVzZSB0aGUgcnVuX2FzYCk7XG5cbiAgICBjb25zdCByZWdpc3RyeUhvc3QgPSB0aGlzLmdldFJlZ2lzdHJ5QnlIb3N0KGFwaUlkKTtcbiAgICBpZiAoIXJlZ2lzdHJ5SG9zdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQVBJIGhvc3Qgd2l0aCBJRCBbJHthcGlJZH1dIHdhcyBub3QgZm91bmQgaW4gdGhlIHJlZ2lzdHJ5LiBUaGlzIGNvdWxkIGJlIGNhdXNlZCBieSBhIHByb2JsZW0gZ2V0dGluZyBhbmQgc3RvcmluZyB0aGUgcmVnaXN0cnkgZGF0YSBvciB0aGUgQVBJIGhvc3Qgd2FzIHJlbW92ZWQuYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChyZWdpc3RyeUhvc3QuYWxsb3dfcnVuX2FzID09PSBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLlVOQUJMRV9UT19DSEVDSykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQVBJIGhvc3Qgd2l0aCBob3N0IElEIFske2FwaUlkfV0gY291bGQgbm90IGNoZWNrIHRoZSBhYmlsaXR5IHRvIHVzZSB0aGUgcnVuIGFzLiBFbnN1cmUgdGhlIEFQSSBob3N0IGlzIGFjY2VzaWJsZSBhbmQgdGhlIGludGVybmFsIHVzZXIgaGFzIHRoZSBtaW5pbWFsIHBlcm1pc3Npb25zIHRvIGNoZWNrIHRoaXMgY2FwYWJpbGl0eS5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHJlZ2lzdHJ5SG9zdC5hbGxvd19ydW5fYXMgPT09IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuVVNFUl9OT1RfQUxMT1dFRCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQVBJIGhvc3Qgd2l0aCBob3N0IElEIFske2FwaUlkfV0gbWlzY29uZmlndXJlZC4gVGhlIGNvbmZpZ3VyYXRlZCBBUEkgdXNlciBpcyBub3QgYWxsb3dlZCB0byB1c2UgW3J1bl9hc10uIEFsbG93IGl0IGluIHRoZSBBUEkgdXNlciBjb25maWd1cmF0aW9uIG9yIHNldCBbcnVuX2FzXSBob3N0IHNldHRpbmcgd2l0aCBbZmFsc2VdIHZhbHVlLmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8qIFRoZSBhbGxvd2VkIHZhbHVlcyB0byBjb21wYXJlIHNob3VsZCBiZTpcbiAgICAgIEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuRU5BQkxFRDogdXNlIHJ1bl9hc1xuICAgICAgQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5IT1NUX0RJU0FCTEVEOiBub3QgdXNlIHJ1bl9hc1xuICAgICAgQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5BTExfRElTQUJMRUQ6IG5vdCB1c2UgcnVuX2FzXG4gICAgKi9cbiAgICBpZiAoXG4gICAgICAhW1xuICAgICAgICBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkVOQUJMRUQsXG4gICAgICAgIEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuSE9TVF9ESVNBQkxFRCxcbiAgICAgICAgQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5BTExfRElTQUJMRUQsXG4gICAgICBdLmluY2x1ZGVzKHJlZ2lzdHJ5SG9zdC5hbGxvd19ydW5fYXMpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBUEkgaG9zdCB3aXRoIGhvc3QgSUQgWyR7YXBpSWR9XSBoYXMgYW4gdW5leHBlY3RlZCB2YWx1ZSBbJHtyZWdpc3RyeUhvc3QuYWxsb3dfcnVuX2FzfV0gc3RvcmVkIGluIHRoZSByZWdpc3RyeS4gVGhpcyBjb3VsZCBiZSBjYXVzZWQgYnkgYSBwcm9ibGVtIGdldHRpbmcgYW5kIHN0b3JpbmcgdGhlIHJlZ2lzdHJ5IGRhdGEuYCxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiByZWdpc3RyeUhvc3QuYWxsb3dfcnVuX2FzID09PSBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkVOQUJMRUQ7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBY0EsSUFBQUEsbUJBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLFVBQUEsR0FBQUQsT0FBQTtBQUEyRCxTQUFBRSxnQkFBQUMsR0FBQSxFQUFBQyxHQUFBLEVBQUFDLEtBQUEsSUFBQUQs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